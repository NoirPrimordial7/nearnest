rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {

    // ----- Avatars -----
    match /avatars/{uid}/{file=**} {
      allow read:  if request.auth != null;                         // for getDownloadURL
      allow write: if request.auth != null && request.auth.uid == uid;
    }

    // ----- Store verification documents -----
    // Path used by app: storeDocs/{storeId}/{docId-or-kind}-{filename}
    match /storeDocs/{storeId}/{file=**} {

      // Read the store doc from Firestore (Storage rules MUST use (default))
      function _store() {
        return firestore.get(/databases/(default)/documents/stores/$(storeId)).data;
      }

      function _isOwner() {
        return request.auth != null
               && _store() != null
               && _store().ownerId == request.auth.uid;
      }

      function _isMember() {
        return request.auth != null
               && _store() != null
               && _store().members != null
               && (request.auth.uid in _store().members
                   || request.auth.uid in _store().members.keys());
      }

      // Owner or members can read their uploads
      allow read: if _isOwner() || _isMember();

      // Owner or members can write; only allow images or PDFs
      allow write: if (_isOwner() || _isMember())
                   && request.resource != null
                   && (
                        request.resource.contentType.matches('image/.*')
                        || request.resource.contentType == 'application/pdf'
                      );
    }

    // Default deny
    match /{allPaths=**} { allow read, write: if false; }
  }
}
