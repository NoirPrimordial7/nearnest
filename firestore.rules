rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    /* ---------- helpers ---------- */
    function signedIn() { return request.auth != null; }

    function isOwner(ownerId) {
      return signedIn() && request.auth.uid == ownerId;
    }

    function isMember(members) {
      return signedIn()
        && members != null
        && (request.auth.uid in members || request.auth.uid in members.keys());
    }

    function isVisibleTo(visibleTo) {
      return signedIn()
        && visibleTo != null
        && visibleTo.hasAny([request.auth.uid]);
    }

    // read the store once and reuse
    function storeDoc(storeId) {
      return get(/databases/$(database)/documents/stores/$(storeId));
    }

    function canAccessStore(storeId) {
      return isOwner(storeDoc(storeId).data.ownerId)
          || isMember(storeDoc(storeId).data.members)
          || isVisibleTo(storeDoc(storeId).data.visibleTo);
    }

    /* ---------- users ---------- */
    match /users/{uid} {
      allow read, write: if signedIn() && request.auth.uid == uid;
    }

    /* ---------- stores ---------- */
    match /stores/{storeId} {
      // read store doc if the user can access it
      allow read: if canAccessStore(storeId);

      // create only if declaring yourself the owner
      allow create: if signedIn() &&
        request.resource.data.ownerId == request.auth.uid;

      // updates by owner or member; delete only by owner
      allow update: if signedIn() && (
        isOwner(resource.data.ownerId) || isMember(resource.data.members)
      );
      allow delete: if signedIn() && isOwner(resource.data.ownerId);

      /* --- verification documents: stores/{storeId}/documents/{docId} --- */
      match /documents/{docId} {
        allow read: if canAccessStore(storeId);

        // uploader must be the signed-in user; basic field validation
        allow create: if canAccessStore(storeId)
          && request.resource.data.path is string
          && request.resource.data.url  is string
          && request.resource.data.kind is string
          && request.resource.data.uploadedBy == request.auth.uid;

        // owner or original uploader can modify/delete
        allow update: if signedIn() && (
          isOwner(storeDoc(storeId).data.ownerId) ||
          request.resource.data.uploadedBy == request.auth.uid
        );

        allow delete: if signedIn() && (
          isOwner(storeDoc(storeId).data.ownerId) ||
          resource.data.uploadedBy == request.auth.uid
        );
      }

      /* fallback for any other subcollections under a store */
      match /{sub=**}/{docId} {
        allow read:  if canAccessStore(storeId);
        allow write: if signedIn() && (
          isOwner(storeDoc(storeId).data.ownerId) ||
          isMember(storeDoc(storeId).data.members)
        );
      }
    }

    /* ---------- default deny ---------- */
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
