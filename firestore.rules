rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    /* ------------ helpers ------------ */
    function signedIn() { return request.auth != null; }

    function userDoc(uid) {
      return get(/databases/$(database)/documents/users/$(uid));
    }

    function isAdmin() {
      return signedIn()
        && userDoc(request.auth.uid).exists()
        && userDoc(request.auth.uid).data.roles is list
        && userDoc(request.auth.uid).data.roles.hasAny(['admin']);
    }

    function isOwner(ownerId) {
      return signedIn() && ownerId != null && request.auth.uid == ownerId;
    }

    // Accept members as MAP: { "<uid>": true } OR ARRAY: ["<uid>", ...]
    function isMember(members) {
      return signedIn()
        && members != null
        && (
             (members[request.auth.uid] == true) ||
             (members is list && members.hasAny([request.auth.uid]))
           );
    }

    function isVisibleTo(visibleTo) {
      return signedIn()
        && visibleTo != null
        && visibleTo.hasAny([request.auth.uid]);
    }

    // For subcollections (we can't use resource.data of the parent there)
    function storeDoc(storeId) {
      return get(/databases/$(database)/documents/stores/$(storeId));
    }

    function canAccessStoreViaDoc(s) {
      return isOwner(s.data.ownerId)
          || isMember(s.data.members)
          || isVisibleTo(s.data.visibleTo)
          || isAdmin();
    }

    /* ------------ users ------------ */
    match /users/{uid} {
      allow read:  if (signedIn() && request.auth.uid == uid) || isAdmin();
      allow write: if signedIn() && request.auth.uid == uid;
    }

    /* ------------ stores ------------ */
    match /stores/{storeId} {
      // IMPORTANT: use resource.data directly (no self-get)
      allow read: if
        isOwner(resource.data.ownerId) ||
        isMember(resource.data.members) ||
        isVisibleTo(resource.data.visibleTo) ||
        isAdmin();

      // Owner (self) or admin can create
      allow create: if signedIn() && (
        request.resource.data.ownerId == request.auth.uid || isAdmin()
      );

      // Owner/member/admin can update
      allow update: if signedIn() && (
        isOwner(resource.data.ownerId) ||
        isMember(resource.data.members) ||
        isAdmin()
      );

      // Only owner or admin can delete
      allow delete: if signedIn() && (
        isOwner(resource.data.ownerId) || isAdmin()
      );

      /* --- verification docs: stores/{storeId}/documents/{docId} --- */
      match /documents/{docId} {
        allow read: if canAccessStoreViaDoc(storeDoc(storeId));

        allow create: if canAccessStoreViaDoc(storeDoc(storeId))
          && request.resource.data.path is string
          && request.resource.data.url  is string
          && request.resource.data.kind is string
          && request.resource.data.uploadedBy is string
          && (
               request.resource.data.uploadedBy == request.auth.uid
               || isAdmin()
             );

        // uploadedBy cannot change (unless admin)
        allow update: if signedIn() && (
          isOwner(storeDoc(storeId).data.ownerId) ||
          (resource.data.uploadedBy == request.auth.uid &&
           request.resource.data.uploadedBy == resource.data.uploadedBy) ||
          isAdmin()
        );

        allow delete: if signedIn() && (
          isOwner(storeDoc(storeId).data.ownerId) ||
          resource.data.uploadedBy == request.auth.uid ||
          isAdmin()
        );
      }

      /* --- any other subcollections under a store --- */
      match /{sub=**}/{docId} {
        allow read:  if canAccessStoreViaDoc(storeDoc(storeId));
        allow write: if signedIn() && (
          isOwner(storeDoc(storeId).data.ownerId) ||
          isMember(storeDoc(storeId).data.members) ||
          isAdmin()
        );
      }
    }

    /* ------------ (optional) other top-level collections ------------ */
    match /projects/{docId} {
      allow read: if signedIn() && (
        resource.data.ownerId == request.auth.uid ||
        (resource.data.visibleTo != null &&
         resource.data.visibleTo.hasAny([request.auth.uid])) ||
        (resource.data.public == true) || isAdmin()
      );
      allow create: if signedIn() &&
        request.resource.data.ownerId == request.auth.uid;
      allow update, delete: if signedIn() && (
        resource.data.ownerId == request.auth.uid || isAdmin()
      );
    }

    match /workspaces/{docId} {
      allow read: if signedIn() && (
        resource.data.ownerId == request.auth.uid ||
        (resource.data.visibleTo != null &&
         resource.data.visibleTo.hasAny([request.auth.uid])) ||
        (resource.data.public == true) || isAdmin()
      );
      allow create: if signedIn() &&
        request.resource.data.ownerId == request.auth.uid;
      allow update, delete: if signedIn() && (
        resource.data.ownerId == request.auth.uid || isAdmin()
      );
    }

    match /branding/{docId} {
      allow read: if signedIn() && (
        resource.data.ownerId == request.auth.uid ||
        (resource.data.visibleTo != null &&
         resource.data.visibleTo.hasAny([request.auth.uid])) ||
        (resource.data.public == true) || isAdmin()
      );
      allow create: if signedIn() &&
        request.resource.data.ownerId == request.auth.uid;
      allow update, delete: if signedIn() && (
        resource.data.ownerId == request.auth.uid || isAdmin()
      );
    }

    /* ------------ default deny ------------ */
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
