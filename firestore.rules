rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ---------- Common Helpers ----------
    function signedIn() {
      return request.auth != null;
    }

    function userDoc(uid) {
      return get(/databases/$(database)/documents/users/$(uid));
    }

    function isOwner(ownerId) {
      return signedIn() && ownerId != null && request.auth.uid == ownerId;
    }

    function isMemberPlus(members, membersArr) {
      return signedIn() && (
        (members != null && (members[request.auth.uid] == true)) ||
        (membersArr is list && membersArr.hasAny([request.auth.uid]))
      );
    }

    function isVisibleTo(visibleTo) {
      return signedIn() && visibleTo != null && visibleTo.hasAny([request.auth.uid]);
    }

    function storeDoc(storeId) {
      return get(/databases/$(database)/documents/stores/$(storeId));
    }

    // ---------- Verifier/Admin Access ----------
    function canVerifyDocs() {
      return signedIn()
        && userDoc(request.auth.uid).data != null

        && (
          // Global admin role
          (userDoc(request.auth.uid).data.roles is list
            && userDoc(request.auth.uid).data.roles.hasAny(['admin']))
          ||
          // Explicit VERIFY_DOCS permission
          (userDoc(request.auth.uid).data.permissions is list
            && userDoc(request.auth.uid).data.permissions.hasAny(['VERIFY_DOCS']))
          ||
          // Verifier fallback role
          (userDoc(request.auth.uid).data.roles is list
            && userDoc(request.auth.uid).data.roles.hasAny(['verifier']))
        );
    }

    function canAccessStore(storeId) {
      let s = storeDoc(storeId);
      return isOwner(s.data.ownerId)
        || isMemberPlus(s.data.members, s.data.membersArr)
        || isVisibleTo(s.data.visibleTo)
        || canVerifyDocs();
    }

    // ---------- USERS ----------
    match /users/{uid} {
      allow read: if signedIn() && (request.auth.uid == uid || canVerifyDocs());
      allow update: if signedIn() && (request.auth.uid == uid || canVerifyDocs());
      allow create: if signedIn();
    }

    // ---------- ROLES ----------
    match /roles/{roleId} {
      allow read: if signedIn();
    }

    // ---------- STORES ----------
    match /stores/{storeId} {
      allow read, get, list: if canAccessStore(storeId);
      allow create: if signedIn();

      // Admin/Verifier or Owner can update verification status
      allow update: if signedIn() && (
        isOwner(resource.data.ownerId) ||
        canVerifyDocs()
      );

      allow delete: if signedIn() && (
        isOwner(resource.data.ownerId) ||
        userDoc(request.auth.uid).data.roles.hasAny(['admin'])
      );

      // ---------- Subcollection: documents ----------
      match /documents/{docId} {
        allow read: if canAccessStore(storeId);

        // Owner/uploader or verifier/admin
        allow create: if signedIn() && (
          request.resource.data.uploadedBy == request.auth.uid ||
          canVerifyDocs()
        );

        allow update: if signedIn() && (
          isOwner(storeDoc(storeId).data.ownerId) ||
          resource.data.uploadedBy == request.auth.uid ||
          canVerifyDocs()
        );

        allow delete: if signedIn() && (
          isOwner(storeDoc(storeId).data.ownerId) ||
          resource.data.uploadedBy == request.auth.uid ||
          canVerifyDocs()
        );
      }

      // ---------- Subcollection: verificationLogs ----------
      match /verificationLogs/{logId} {
        allow read: if canAccessStore(storeId);
        allow create: if signedIn() && canVerifyDocs();
      }

      // Fallback for any other store subcollections (e.g., analytics, etc.)
      match /{sub=**}/{docId} {
        allow read: if canAccessStore(storeId);
        allow write: if signedIn() && (
          isOwner(storeDoc(storeId).data.ownerId) || canVerifyDocs()
        );
      }
    }

    // ---------- Global fallback ----------
    match /{document=**} {
      allow read: if signedIn();
    }
  }
}
