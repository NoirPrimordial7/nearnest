rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    function signedIn() { return request.auth != null; }

    function userDoc(uid) {
      return get(/databases/$(database)/documents/users/$(uid));
    }

    function isAdmin() {
      return signedIn()
        && userDoc(request.auth.uid).exists()
        && userDoc(request.auth.uid).data.roles is list
        && userDoc(request.auth.uid).data.roles.hasAny(['admin']);
    }

    function isOwner(ownerId) {
      return signedIn() && ownerId != null && request.auth.uid == ownerId;
    }

    // allow members as map OR array
    function isMemberMapOrArray(members) {
      return signedIn()
        && members != null
        && (
             (members[request.auth.uid] == true) ||
             (members is list && members.hasAny([request.auth.uid]))
           );
    }

    // also allow legacy membersArr array
    function isMemberPlus(members, membersArr) {
      return isMemberMapOrArray(members)
        || (signedIn() && membersArr is list && membersArr.hasAny([request.auth.uid]));
    }

    function isVisibleTo(visibleTo) {
      return signedIn()
        && visibleTo != null
        && visibleTo.hasAny([request.auth.uid]);
    }

    function storeDoc(storeId) {
      return get(/databases/$(database)/documents/stores/$(storeId));
    }

    function canAccessStoreViaDoc(s) {
      return isOwner(s.data.ownerId)
          || isMemberPlus(s.data.members, s.data.membersArr)
          || isVisibleTo(s.data.visibleTo)
          || isAdmin();
    }

    /* users */
    match /users/{uid} {
      allow read:  if (signedIn() && request.auth.uid == uid) || isAdmin();
      allow write: if signedIn() && request.auth.uid == uid;
    }

    /* stores */
    match /stores/{storeId} {
      allow read: if
        isOwner(resource.data.ownerId) ||
        isMemberPlus(resource.data.members, resource.data.membersArr) ||
        isVisibleTo(resource.data.visibleTo) ||
        isAdmin();

      allow create: if signedIn() && (
        request.resource.data.ownerId == request.auth.uid || isAdmin()
      );

      allow update: if signedIn() && (
        isOwner(resource.data.ownerId) ||
        isMemberPlus(resource.data.members, resource.data.membersArr) ||
        isAdmin()
      );

      allow delete: if signedIn() && (
        isOwner(resource.data.ownerId) || isAdmin()
      );

      /* verification docs */
      match /documents/{docId} {
        allow read: if canAccessStoreViaDoc(storeDoc(storeId));

        allow create: if canAccessStoreViaDoc(storeDoc(storeId))
          && request.resource.data.path is string
          && request.resource.data.url  is string
          && request.resource.data.kind is string
          && request.resource.data.uploadedBy is string
          && (
               request.resource.data.uploadedBy == request.auth.uid
               || isAdmin()
             );

        allow update: if signedIn() && (
          isOwner(storeDoc(storeId).data.ownerId) ||
          (resource.data.uploadedBy == request.auth.uid &&
           request.resource.data.uploadedBy == resource.data.uploadedBy) ||
          isAdmin()
        );

        allow delete: if signedIn() && (
          isOwner(storeDoc(storeId).data.ownerId) ||
          resource.data.uploadedBy == request.auth.uid ||
          isAdmin()
        );
      }

      /* other store subcollections */
      match /{sub=**}/{docId} {
        allow read:  if canAccessStoreViaDoc(storeDoc(storeId));
        allow write: if signedIn() && (
          isOwner(storeDoc(storeId).data.ownerId) ||
          isMemberPlus(storeDoc(storeId).data.members, storeDoc(storeId).data.membersArr) ||
          isAdmin()
        );
      }
    }

    /* default deny */
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
