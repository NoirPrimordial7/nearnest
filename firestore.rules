rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    /* ---------- helpers ---------- */
    function signedIn() { return request.auth != null; }

    function isOwner(ownerId) {
      return signedIn() && ownerId != null && request.auth.uid == ownerId;
    }

    function isMember(members) {
      return signedIn()
        && members != null
        && (request.auth.uid in members || request.auth.uid in members.keys());
    }

    function isVisibleTo(visibleTo) {
      return signedIn()
        && visibleTo != null
        && visibleTo.hasAny([request.auth.uid]);
    }

    // single read accessor
    function storeDoc(storeId) {
      return get(/databases/$(database)/documents/stores/$(storeId));
    }

    function canAccessStore(storeId) {
      let s = storeDoc(storeId);
      return isOwner(s.data.ownerId)
        || isMember(s.data.members)
        || isVisibleTo(s.data.visibleTo);
    }

    /* ---------- users ---------- */
    match /users/{uid} {
      allow read, write: if signedIn() && request.auth.uid == uid;
    }

    /* ---------- stores ---------- */
    match /stores/{storeId} {

      // read allowed if the user can access this store
      allow read: if canAccessStore(storeId);

      // create only by claiming yourself owner
      allow create: if signedIn() &&
        request.resource.data.ownerId == request.auth.uid;

      // update by owner or member
      allow update: if signedIn() && (
        isOwner(resource.data.ownerId) || isMember(resource.data.members)
      );

      // delete only by owner
      allow delete: if signedIn() && isOwner(resource.data.ownerId);

      /* --- verification documents: stores/{storeId}/documents/{docId} --- */
      match /documents/{docId} {
        allow read: if canAccessStore(storeId);

        // create: must be accessible & required fields are strings & uploader is caller
        allow create: if canAccessStore(storeId)
          && request.resource.data.path is string
          && request.resource.data.url  is string
          && request.resource.data.kind is string
          && request.resource.data.uploadedBy == request.auth.uid;

        // update: owner OR original uploader; cannot change uploadedBy to someone else
        allow update: if signedIn() && (
          isOwner(storeDoc(storeId).data.ownerId) ||
          (resource.data.uploadedBy == request.auth.uid &&
           request.resource.data.uploadedBy == resource.data.uploadedBy)
        );

        // delete: owner OR original uploader
        allow delete: if signedIn() && (
          isOwner(storeDoc(storeId).data.ownerId) ||
          resource.data.uploadedBy == request.auth.uid
        );
      }

      /* --- fallback for other subcollections under a store --- */
      match /{sub=**}/{docId} {
        allow read:  if canAccessStore(storeId);
        allow write: if signedIn() && (
          isOwner(storeDoc(storeId).data.ownerId) ||
          isMember(storeDoc(storeId).data.members)
        );
      }
    }

    /* ---------- default deny ---------- */
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
