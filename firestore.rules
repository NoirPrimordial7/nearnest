rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function signedIn() { return request.auth != null; }

    // Optional admin support via custom claims:
    //  - request.auth.token.admin == true, or
    //  - roles array includes "admin"
    function isAdmin() {
      return signedIn() && (
        (request.auth.token.admin == true) ||
        ("roles" in request.auth.token && "admin" in request.auth.token.roles)
      );
    }

    /* -------------------- users -------------------- */
    // User can read/write own profile; admins can override.
    match /users/{uid} {
      allow read:  if signedIn() && (request.auth.uid == uid || isAdmin());
      allow write: if signedIn() && (request.auth.uid == uid || isAdmin());
    }

    /* -------------------- stores ------------------- */
    // Helpers
    function isOwnerCreate() {
      return request.method == 'create'
             && request.resource.data.ownerId == request.auth.uid;
    }
    function isOwnerExisting() {
      return request.method != 'create'
             && resource.data.ownerId == request.auth.uid;
    }
    // members: map keyed by uid -> true
    function inMembers(data) {
      return data.members != null
             && request.auth.uid in data.members.keys();
    }
    // visibleTo: array of uids
    function inVisible(data) {
      return data.visibleTo != null
             && data.visibleTo.hasAny([request.auth.uid]);
    }

    match /stores/{storeId} {
      // READ: owner, member, visibleTo, or admin
      allow get, list: if signedIn() && (
        isOwnerExisting() || inMembers(resource.data) || inVisible(resource.data) || isAdmin()
      );

      // CREATE: must set ownerId = self (or admin creating)
      allow create: if signedIn() && (
        isOwnerCreate() || isAdmin()
      );

      // UPDATE / DELETE: owner or admin
      allow update, delete: if signedIn() && (
        isOwnerExisting() || isAdmin()
      );
    }

    /* ---------------- default deny ---------------- */
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
