rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    function signedIn() { return request.auth != null; }
    function isOwner(ownerId) { return signedIn() && request.auth.uid == ownerId; }
    function isMember(members) {
      return signedIn()
        && members != null
        && (request.auth.uid in members || request.auth.uid in members.keys());
    }
    function isVisibleTo(visibleTo) {
      return signedIn() && visibleTo != null && visibleTo.hasAny([request.auth.uid]);
    }

    // Helper: can the current user access this store?
    function canAccessStore(storeId) {
      let store = get(/databases/$(database)/documents/stores/$(storeId)).data;
      return isOwner(store.ownerId) || isMember(store.members) || isVisibleTo(store.visibleTo);
    }

    // users
    match /users/{uid} {
      allow read, write: if signedIn() && request.auth.uid == uid;
    }

    // stores
    match /stores/{storeId} {
      // existing docs
      allow read: if canAccessStore(storeId);

      // create: only the owner (by declaring ownerId = auth.uid)
      allow create: if signedIn() && request.resource.data.ownerId == request.auth.uid;

      // update/delete: owner or a member
      allow update, delete: if signedIn() && (
        isOwner(resource.data.ownerId) || isMember(resource.data.members)
      );

      // subcollection: stores/{storeId}/documents/{docId}
      match /documents/{docId} {
        // owner and members can read
        allow read: if canAccessStore(storeId);

        // owner or members can create (upload)
        allow create: if signedIn() && (
          isOwner(get(/databases/$(database)/documents/stores/$(storeId)).data.ownerId) ||
          isMember(get(/databases/$(database)/documents/stores/$(storeId)).data.members)
        );

        // only owner can update/delete a specific document
        allow update, delete: if signedIn() &&
          isOwner(get(/databases/$(database)/documents/stores/$(storeId)).data.ownerId);
      }
    }

    // default deny
    match /{document=**} { allow read, write: if false; }
  }
}
