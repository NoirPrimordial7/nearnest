rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    /* ------------ helpers ------------ */
    function signedIn() { return request.auth != null; }

    function userDoc(uid) {
      return get(/databases/$(database)/documents/users/$(uid));
    }

    function isAdmin() {
      return signedIn()
        && userDoc(request.auth.uid).exists()
        && userDoc(request.auth.uid).data.roles is list
        && userDoc(request.auth.uid).data.roles.hasAny(['admin']);
    }

    function isOwner(ownerId) {
      return signedIn() && ownerId != null && request.auth.uid == ownerId;
    }

    function isMember(members) {
      return signedIn()
        && members != null
        && (request.auth.uid in members || request.auth.uid in members.keys());
    }

    function isVisibleTo(visibleTo) {
      return signedIn()
        && visibleTo != null
        && visibleTo.hasAny([request.auth.uid]);
    }

    function storeDoc(storeId) {
      return get(/databases/$(database)/documents/stores/$(storeId));
    }

    function canAccessStore(storeId) {
      let s = storeDoc(storeId);
      return isOwner(s.data.ownerId)
          || isMember(s.data.members)
          || isVisibleTo(s.data.visibleTo);
    }

    /* ------------ users ------------ */
    match /users/{uid} {
      allow read:  if (signedIn() && request.auth.uid == uid) || isAdmin();
      allow write: if signedIn() && request.auth.uid == uid;
    }

    /* ------------ stores ------------ */
    match /stores/{storeId} {
      allow read: if canAccessStore(storeId) || isAdmin();

      allow create: if signedIn() && (
        request.resource.data.ownerId == request.auth.uid || isAdmin()
      );

      allow update: if signedIn() && (
        isOwner(resource.data.ownerId) ||
        isMember(resource.data.members) ||
        isAdmin()
      );

      allow delete: if signedIn() && (
        isOwner(resource.data.ownerId) || isAdmin()
      );

      /* verification docs */
      match /documents/{docId} {
        allow read: if canAccessStore(storeId) || isAdmin();

        allow create: if (canAccessStore(storeId) || isAdmin())
          && request.resource.data.path is string
          && request.resource.data.url  is string
          && request.resource.data.kind is string
          && request.resource.data.uploadedBy is string
          && (
            request.resource.data.uploadedBy == request.auth.uid
            || isAdmin()
          );

        // uploadedBy canâ€™t be reassigned unless admin
        allow update: if signedIn() && (
          isOwner(storeDoc(storeId).data.ownerId) ||
          (resource.data.uploadedBy == request.auth.uid &&
           request.resource.data.uploadedBy == resource.data.uploadedBy) ||
          isAdmin()
        );

        allow delete: if signedIn() && (
          isOwner(storeDoc(storeId).data.ownerId) ||
          resource.data.uploadedBy == request.auth.uid ||
          isAdmin()
        );
      }

      /* other subcollections under a store */
      match /{sub=**}/{docId} {
        allow read:  if canAccessStore(storeId) || isAdmin();
        allow write: if signedIn() && (
          isOwner(storeDoc(storeId).data.ownerId) ||
          isMember(storeDoc(storeId).data.members) ||
          isAdmin()
        );
      }
    }

    /* ------------ DASHBOARD collections (top-level) ------------ */
    /* projects */
    match /projects/{docId} {
      allow read: if signedIn() && (
        (resource.data.public == true) ||
        resource.data.ownerId == request.auth.uid ||
        (resource.data.visibleTo != null &&
         resource.data.visibleTo.hasAny([request.auth.uid])) ||
        isAdmin()
      );
      allow create: if signedIn() &&
        request.resource.data.ownerId == request.auth.uid;
      allow update, delete: if signedIn() && (
        resource.data.ownerId == request.auth.uid || isAdmin()
      );
    }

    /* workspaces */
    match /workspaces/{docId} {
      allow read: if signedIn() && (
        resource.data.ownerId == request.auth.uid ||
        (resource.data.visibleTo != null &&
         resource.data.visibleTo.hasAny([request.auth.uid])) ||
        isAdmin()
      );
      allow create: if signedIn() &&
        request.resource.data.ownerId == request.auth.uid;
      allow update, delete: if signedIn() && (
        resource.data.ownerId == request.auth.uid || isAdmin()
      );
    }

    /* branding */
    match /branding/{docId} {
      allow read: if signedIn() && (
        resource.data.ownerId == request.auth.uid ||
        (resource.data.visibleTo != null &&
         resource.data.visibleTo.hasAny([request.auth.uid])) ||
        isAdmin()
      );
      allow create: if signedIn() &&
        request.resource.data.ownerId == request.auth.uid;
      allow update, delete: if signedIn() && (
        resource.data.ownerId == request.auth.uid || isAdmin()
      );
    }

    /* ------------ default deny ------------ */
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
